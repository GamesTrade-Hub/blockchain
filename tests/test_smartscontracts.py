import unittest
from src import app
import json
import time


class TestMining(unittest.TestCase):
    def setUp(self):
        self.app = app.test_client()
        self.app.post('/transaction/new', json={
            "sender": "107586176969073111214138186621388472896166149958805892498797251438836201351897A74644521699183317518461259885566371696845701675874024848140772236522116872470",
            "recipient": "20814445768936213437274626353616804800165280588630009899878751548100521042725A19241468249812662668563130259817649756265743308017717653468619451285872265293",
            "amount": 50, "token": "snowy",
            "private_key": "96281203938515529592468945178611699390852145171871882015412702005631509756531"})
        self.app.post('/transaction/new', json={
            "sender": "107586176969073111214138186621388472896166149958805892498797251438836201351897A74644521699183317518461259885566371696845701675874024848140772236522116872470",
            "recipient": "45924479284721020088255655764259838493632121191345267194632595708284069229257A64353570746271633642239099441557900798355211921538755593764691886599926285870",
            "amount": 10, "token": "snowy",
            "private_key": "96281203938515529592468945178611699390852145171871882015412702005631509756531"})
        self.app.post('/create_block')
        self.app.get('/mine', follow_redirects=True)

    def test_smartscontracts(self):
        response = self.app.post('/transaction/new', json={
            "sender": "20814445768936213437274626353616804800165280588630009899878751548100521042725A19241468249812662668563130259817649756265743308017717653468619451285872265293",
            "recipient": "45924479284721020088255655764259838493632121191345267194632595708284069229257A64353570746271633642239099441557900798355211921538755593764691886599926285870",
            "amount": 50,
            "private_key": "82071682867393694911507508357139147081659092296130835724380999832955540204790",
            "token": "snowy",
            "sc": {
                "type": "OTHER_TX_CHECK",
                "recipient": "20814445768936213437274626353616804800165280588630009899878751548100521042725A19241468249812662668563130259817649756265743308017717653468619451285872265293",
                "sender": "45924479284721020088255655764259838493632121191345267194632595708284069229257A64353570746271633642239099441557900798355211921538755593764691886599926285870",
                "amount": 10,
                "token": "snowy"
            }
        })
        print("hello")
        print(response.get_data())
        print('hello3')
        self.assertEqual(response.status_code, 201)
        response = self.app.post('/transaction/new', json={
            "sender": "45924479284721020088255655764259838493632121191345267194632595708284069229257A64353570746271633642239099441557900798355211921538755593764691886599926285870",
            "recipient": "20814445768936213437274626353616804800165280588630009899878751548100521042725A19241468249812662668563130259817649756265743308017717653468619451285872265293",
            "amount": 10,
            "private_key": "91731677430373908352199137307720571905361632738435022871770280430996789639289",
            "token": "snowy",
            "sc": {
                "type": "OTHER_TX_CHECK",
                "recipient": "45924479284721020088255655764259838493632121191345267194632595708284069229257A64353570746271633642239099441557900798355211921538755593764691886599926285870",
                "sender": "20814445768936213437274626353616804800165280588630009899878751548100521042725A19241468249812662668563130259817649756265743308017717653468619451285872265293",
                "amount": 50,
                "token": "snowy"
            }
        })
        print('hello2')
        self.assertEqual(response.status_code, 201)

        response = self.app.post('/create_block')
        self.assertEqual(response.status_code, 200)
        self.app.get('/mine', follow_redirects=True)

        response = self.app.get('/get_balance', json={'user_id': '45924479284721020088255655764259838493632121191345267194632595708284069229257A64353570746271633642239099441557900798355211921538755593764691886599926285870'})
        self.assertEqual(json.loads(response.get_data())['snowy'], 50)

        response = self.app.post('/get_balance_by_token', json={'user_id': '45924479284721020088255655764259838493632121191345267194632595708284069229257A64353570746271633642239099441557900798355211921538755593764691886599926285870', 'token': 'snowy'})
        self.assertEqual(json.loads(response.get_data())['balance'], 50)

    def test_error(self):
        response = self.app.post('/transaction/new', json={})
        self.assertEqual(response.status_code, 400)
        response = self.app.post('/get_balance_by_token', json={})
        self.assertEqual(response.status_code, 400)
        response = self.app.get('/get_balance', json={})
        self.assertEqual(response.status_code, 400)


if __name__ == '__main__':
    unittest.main()
